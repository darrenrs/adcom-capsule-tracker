<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" type="image/png" href="Plastic.png">
<title>Crusade Event Free Capsules</title>
<style type="text/css">
h3 {
	margin: 5px;
}

p {
	margin: 5px;
}

.section {
	border-style: solid;
	margin-bottom: 5px;
	width: 550px;
}

.label { /* taken from scripter17's adcomm-capsule-finder */
	color: white;
	text-shadow:1px 1px 0px black, 1px -1px 0px black, -1px 1px 0px black, -1px -1px 0px black;
	text-align:right;
	line-height:calc(300%);
}

.startOverride {
	background-color: teal;
	color: lightblue;
}
.path {
	background-color: lightblue;
}

.capsule {
	width: 40px;
	height: 35px;
	margin: 5px 5px;
	background-repeat: no-repeat;
	background-position: center;
	display: inline-block;
}
.Plastic {
	background-image: url("Plastic.png");
}
.Armored {
	background-image: url("Armored.png");
}
.Wild1 {
	background-image: url("Wild1.png");
}
.Wild5 {
	background-image: url("Wild5.png");
}
.remove {
	background-image: url("remove-small.png");
}
.export {
	background-image: url("Export.png");
}

.possible-end {
	background-color: #a7f45a;
}

#currentCapsules {
	min-height: 45px;
}
#resultsTable {
	text-align:center;
}
#resultsTable td {
	padding: 5px;
}
#dividingBar {
	border-left: 4px solid;
	display: inline-block;
	height: 40px;
	width: 0px;
	margin: 0px 10px 0px 10px;
	
}
</style>
</head>
<body>
<p>
<div class="section">
	<h3>Capsule History:</h3>
	<p><strong>Capsule List:</strong></p>
	<div id="currentCapsules">&nbsp;</div>
	<p><strong>Add Capsule:</strong></p>
	<div>
		<a href="#" onclick="addCapsule('P');"><span class="capsule Plastic">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('A');"><span class="capsule Armored">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('1');"><span class="capsule Wild1">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('5');"><span class="capsule Wild5">&nbsp;</span></a>
		<span id="dividingBar">&nbsp;</span>
		<a href="#" onclick="toggleBlock('exportBlock');"><span class="capsule export">&nbsp;</span></a>
		<a href="#" onclick="removeCapsule();"><span class="capsule remove">&nbsp;</span></a>
	</div>
	<p id='exportBlock' style='display:none;'><strong>Export URL:</strong> <input id='exportUrl' type='text' size='40'></input><p>
</div>
<div class="section">
	<h3>Next Capsule:</h3>
	<p id="results">&nbsp;</p>
</div>
<div class="section">
	<h3>Cycle</h3>
	<div id="table"></div>
</div>
<p><a href='https://zephyron1237.github.io/adcom-capsule-tracker/'>[Main Game Tracker]</a></p>
<p>Made by Zephyron1237. Source on <a href='https://github.com/zephyron1237/adcom-capsule-tracker'>GitHub</a>. Version 3 (<a href='#' onclick="toggleBlock('changelist')">Changelist</a>)</p>
<div id="changelist" style="display:none">
<ul>
<li><strong>Version 3</strong>
	<ul>
	<li>Added wildcards for 1 capsule and 1-5 capsules.</li>
	<li>Added optional starting capsule override.</li>
	<li>Added export/import.</li>
	<li>UI Improvements</li>
	</ul>
</li>
<li><strong>Version 2</strong>
	<ul>
	<li>Added automatic saving of progress.</li>
	<li>Added ranges for expected distances to each capsule type.</li>
	</ul>
</li>
</ul>
</div>
</body>
<script type="text/javascript">
// Taken from the event's Balance.json on May 30, 2019
const GAME_DATA_JSON = ["plastic","plastic","armored","plastic","plastic","plastic","armored","plastic","plastic","plastic","armored","plastic","plastic","plastic","armored","plastic","plastic","plastic","armored","plastic","plastic","plastic","armored","plastic"]

const CYCLE = GAME_DATA_JSON.map(name => name[0].toUpperCase()).join('');

const CAPSULES = [
{ name: "Plastic", symbol: "P" },
{ name: "Armored", symbol: "A" },
];

var SYMBOL_TO_NAME = {
	1: 'Wild1',
	5: 'Wild5'
};
for (var capsule of CAPSULES) {
	SYMBOL_TO_NAME[capsule.symbol] = capsule.name;
}

var splitUrl = window.location.href.split('?');
if (splitUrl.length == 2) {
	localStorage.setItem('currentInputCrusade', '');
	localStorage.setItem('startOverrideCrusade', -1);
	
	var arguments = splitUrl[1].split('&');
	for (var arg of arguments) {
		var keyValue = arg.split('=');
		if (keyValue.length != 2) continue;
		if (keyValue[0] == 'start') {
			localStorage.setItem('startOverrideCrusade', parseInt(keyValue[1]) - 1);
		} else if (keyValue[0] == 'input') {
			localStorage.setItem('currentInputCrusade', keyValue[1]);
		}
	}
	window.location.href = splitUrl[0];
}

if (localStorage.getItem('currentInputCrusade') == null) {
	localStorage.setItem('currentInputCrusade', '');
}
if (localStorage.getItem('startOverrideCrusade') == null) {
	localStorage.setItem('startOverrideCrusade', -1);
}
updateAfterInput();

function addCapsule(symbol) {
	localStorage.setItem('currentInputCrusade', localStorage.getItem('currentInputCrusade') + symbol);
	updateAfterInput();
}

function removeCapsule() {
	var currentInput = localStorage.getItem('currentInputCrusade');
	if (currentInput == '') {
		localStorage.setItem('startOverrideCrusade', -1);
	} else {
		localStorage.setItem('currentInputCrusade', currentInput.slice(0, -1));
	}
	updateAfterInput();
}

function updateAfterInput() {
	var currentInput = localStorage.getItem('currentInputCrusade');
	var startOverride = parseInt(localStorage.getItem('startOverrideCrusade'));
	
	var foundIndices = findIndicesOfInput();
	var nextIndices = new Set(foundIndices.map(x => x.nextIndex));

	// Update the "capsule history" list
	var table_html = "";
	var label_text = "&nbsp;";
	var path_index = 0;
	var cur_label_index = (nextIndices.size != 1) ? -1 : foundIndices[0].path[0];
	
	if (startOverride != -1) {		
		var symbol_class = SYMBOL_TO_NAME[CYCLE[startOverride]];
		var override_label = startOverride + 1;
		table_html += "<a href='#' onclick='setStartOverride(-1)'><span class='startOverride label capsule " + symbol_class + "'>" + override_label + "</span></a>";
	}
	
	for (var symbol of currentInput) {
		var inputClass = SYMBOL_TO_NAME[symbol];
		if (nextIndices.size == 1) {
			inputClass += " path";
			if (symbol != '5') { // 5 means special 1-5 wildcard
				label_text = (cur_label_index + 1);
				cur_label_index = (cur_label_index + 1) % CYCLE.length;				
			} else {
				label_text = "&nbsp;";
				path_index++;
				cur_label_index = foundIndices[0].path[path_index];
			}			
		}
		table_html += "<span class='label capsule " + inputClass + "'>" + label_text + "</span>";
	}
	document.getElementById("currentCapsules").innerHTML = table_html || "&nbsp;";
	
	var exportUrl = "https://zephyron1237.github.io/adcom-capsule-tracker/crusade.html?";
	if (nextIndices.size == 1) {
		 exportUrl += "start=" + (foundIndices[0].lastIndex + 1);
	} else {
		if (startOverride != -1) {
			exportUrl += "start=" + (startOverride + 1) + "&";
		}
		exportUrl += "input=" + currentInput;
	}
	document.getElementById("exportUrl").value = exportUrl;

	// Update the Cycle table
	drawCycleTable();
	
	// Highlight Cycle table
	if (startOverride != -1) {
		document.getElementById(startOverride).classList.add('startOverride');
	}
	if (nextIndices.size == 1) {
		for (var index = foundIndices[0].startIndex; index != foundIndices[0].nextIndex; index = (index + 1) % CYCLE.length) {
			if (index == startOverride) continue;
			document.getElementById(index).classList.add('path');
		}		
	}

	// Determine results and display them
	if (currentInput.length == 0 && startOverride == -1) {
		document.getElementById("results").innerHTML = "<ul><li>Add capsules above to see possibilities for the next capsule.</li><li>You can also choose a capsule below to start your history.</li></ul>";
		return;
	}	

	var soonestCapsules = [];
	var symbolCounts = {};
	for (var capsule of CAPSULES) {
		symbolCounts[capsule.symbol] = 0;
	}

	for (var nextIndex of nextIndices) {
		document.getElementById(nextIndex).classList.add("possible-end");
		symbolCounts[CYCLE[nextIndex]]++;
		
		// Find the minimum number of capsules after lastIndex before you open each type of capsule
		var capsuleDistance = {};
		var capsulesFound = 0;
		var searchIndex = nextIndex;
		while (capsulesFound < CAPSULES.length &&
			(searchIndex % CYCLE.length != nextIndex || searchIndex == nextIndex)) {
			
			if (!(CYCLE[searchIndex % CYCLE.length] in capsuleDistance)) {
				capsuleDistance[CYCLE[searchIndex % CYCLE.length]] =
					(searchIndex - nextIndex + CYCLE.length + 1) % CYCLE.length || CYCLE.length;
				capsulesFound++;
			}
			searchIndex++;
		}
		
		soonestCapsules.push(capsuleDistance);
	}
	
	var results_html = "";
	if (nextIndices.size == 0) {
		results_html = "Invalid history. You can use the 'minus' button to remove the most recent capsule.";
	} else {
		if (nextIndices.size > 1) {
			results_html = "Total possibilities: " + nextIndices.size + "<br />";
		}
		// Calculate table cell values
		var tableElements = {};
		for (var capsule of CAPSULES) {
			var tableElement = {};
			var count = symbolCounts[capsule.symbol];
			var percent = Math.round(100 * count / foundIndices.length);
			var distances = soonestCapsules.map(distsPerSymbol => distsPerSymbol[capsule.symbol])
			var min = Math.min(...distances);
			var max = Math.max(...distances);
			var label = "&nbsp;";
			var capsuleClass = capsule.name;
			if (nextIndices.size == 1) {
				if (count > 0) {
					capsuleClass += " possible-end";
				}
				label = ((foundIndices[0].nextIndex + min - 1) % CYCLE.length) + 1;
			}
			tableElement.range_text = (min == max) ? min : min + "-" + max;
			tableElement.count_text = (count == 0) ? "&nbsp;" : count + " (" + percent + "%)";
			tableElement.image_html = "<span class='label capsule " + capsuleClass + "'>" + label + "</span>";
			tableElements[capsule.symbol] = tableElement;
		}

		// Construct the table
		results_html += "<table id='resultsTable'><tr><th>&nbsp;</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].image_html + "</td>";
		}
		
		if (nextIndices.size > 1) {
			results_html += "</tr><tr><th>Next</th>";
			for (var capsule of CAPSULES) {
				results_html += "<td>" + tableElements[capsule.symbol].count_text + "</td>";
			}
		}
		
		results_html += "</tr><tr><th># Until</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].range_text + "</td>";
		}
		results_html += "</tr></table>";
	}
	document.getElementById("results").innerHTML = results_html;
}

function findIndicesOfInput() {
	var startOverride = parseInt(localStorage.getItem('startOverrideCrusade'));
	if (startOverride == -1) {
		return findIndicesOf(localStorage.getItem('currentInputCrusade'), 0, 0, CYCLE.length - 1);
	} else {
		var nextIndex = (startOverride + 1) % CYCLE.length;
		return findIndicesOf(localStorage.getItem('currentInputCrusade'), 0, nextIndex, nextIndex);
	}
}

function findIndicesOf(currentInput, currentInputStart, currentCycleStart, currentCycleEnd) {	
	var result = []
	for (var startIndex = currentCycleStart; startIndex <= currentCycleEnd; startIndex++) {
		var validStartIndex = true;
		for (var inputIndex = currentInputStart; inputIndex < currentInput.length; inputIndex++) {
			if (currentInput[inputIndex] == '5') {
				// 1-5 wildcard, try each possibility
				for (var wildDelta = 1; wildDelta < 6; wildDelta++) {
					var nextIndex = (startIndex + inputIndex + wildDelta - currentInputStart) % CYCLE.length;
					var nextResults = findIndicesOf(currentInput, inputIndex + 1, nextIndex, nextIndex);
					result = result.concat(nextResults.map(x => ({...x, startIndex: startIndex, path: [startIndex, ...x.path]})));
				}
				validStartIndex = false;
				break;
			} else if (currentInput[inputIndex] != '1' && currentInput[inputIndex] != CYCLE[(startIndex + inputIndex - currentInputStart) % CYCLE.length]) {
				validStartIndex = false;
				break;
			}
		}
		
		if (validStartIndex) {
			result.push({
				startIndex: startIndex,
				lastIndex: (startIndex + currentInput.length - currentInputStart - 1) % CYCLE.length,
				nextIndex: (startIndex + currentInput.length - currentInputStart) % CYCLE.length,
				path: [startIndex]
			});
		}
	}

	return result;
}

function drawCycleTable() {
	var table_html = "";
	var index = 0;

	for (var row = 0; row < 3; row++) {
		table_html += "<div>";
		for (var col = 0; col < 8; col++) {
			table_html += "<a href='#' onclick='setStartOverride(" + index + ")'><span id='" + index + "' class='label capsule " + SYMBOL_TO_NAME[CYCLE[index]] + "'>" + (index + 1) + "</span></a>";
			index++;
		}
		table_html += "</div>";
	}

	document.getElementById("table").innerHTML = table_html;
}

function setStartOverride(startOverride) {
	// TODO: Notify user that this is an (in)valid selection. Maybe a BG color animation?
	var currentInput = localStorage.getItem('currentInputCrusade');
	if (startOverride == -1 || currentInput == "") {
		localStorage.setItem('startOverrideCrusade', startOverride);
		updateAfterInput();
	} else {
		var indexAfterStart = (startOverride + 1) % CYCLE.length;
		var foundIndices = findIndicesOf(currentInput, 0, indexAfterStart, indexAfterStart);
		if (foundIndices.length > 0) {
			localStorage.setItem('startOverrideCrusade', startOverride);
			updateAfterInput();
		}		
	}
}

function toggleBlock(blockId) {
	var exportBlock = document.getElementById(blockId);
	if (exportBlock.style.display != 'block') {
		exportBlock.style.display = 'block'
	} else {
		exportBlock.style.display = 'none'
	}
}
</script>
</html>
