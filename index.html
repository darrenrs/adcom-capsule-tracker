<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" type="image/png" href="Wood.png">
<title>Adventure Communist Free Capsules</title>
<style type="text/css">
h3 {
	margin: 5px;
}

.section {
	border-style: solid;
	margin-bottom: 5px;
	width: 550px;
}

.capsule {
	width: 40px;
	height: 35px;
	margin: 5px 5px;
	background-repeat: no-repeat;
	background-position: center;
	display: inline-block;
}
.Wood {
	background-image: url("Wood.png");
}
.Stone {
	background-image: url("Stone.png");
}
.Iron {
	background-image: url("Iron.png");
}
.Epic {
	background-image: url("Epic.png");
}
.Supreme {
	background-image: url("Supreme.png");
}
.remove {
	background-image: url("remove-small.png");
}

.possible-end {
	background-color: #a7f45a;
}

#currentCapsules {
	min-height: 45px;
}
#resultsTable {
	text-align:center;
}
#resultsTable td {
	padding: 5px;
}
</style>
</head>
<body>
<p>
<div class="section">
	<h3>Capsule History:</h3>
	<strong>Capsule List:</strong>
	<div id="currentCapsules">&nbsp;</div>
	<strong>Add Capsule:</strong>
	<div>
		<a href="#" onclick="addCapsule('W');"><span class="capsule Wood">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('S');"><span class="capsule Stone">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('I');"><span class="capsule Iron">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('E');"><span class="capsule Epic">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('U');"><span class="capsule Supreme">&nbsp;</span></a>
		<a href="#" onclick="removeCapsule();"><span class="capsule remove">&nbsp;</span></a>
	</div>
</div>
<div class="section">
	<h3>Next Capsule:</h3>
	<p id="results">&nbsp;</p>
</div>
<div class="section">
	<h3>Cycle</h3>
	<div id="table"></div>
</div>
</body>
<script type="text/javascript">
const CYCLE = "SWWWWIWWWWSWWWSWWWWSWWWWSWWWWSWWWWSWWWWSWWWWWSWWWWSWWWWSWWWWWWSWWWSWWWIWWWSWWWSWWWSWWWSWWWSWWWSWWWSWWSWWWWSWWWWSWWWSWWWUWWWSWWWIWWWWSWWWWWSWWWSWWWSWWWWSWWWWSWWWSWWWSWWWWSWWWWSWWSWWWSWWWSWWWWWIWWWSWWWWSWWWWSWWWWSWWWWWWSWWWWSWWWWSWWWWSWWWWEWW";

const TWO_CYCLES = CYCLE + CYCLE;

const CAPSULES = [
{ name: "Wood", symbol: "W" },
{ name: "Stone", symbol: "S" },
{ name: "Iron", symbol: "I" },
{ name: "Epic", symbol: "E" },
{ name: "Supreme", symbol: "U" }
];

var SYMBOL_TO_NAME = {};
for (var capsule of CAPSULES) {
	SYMBOL_TO_NAME[capsule.symbol] = capsule.name;
}

if (localStorage.getItem('currentInput') == null) {
	localStorage.setItem('currentInput', '');
}
updateAfterInput();

function addCapsule(symbol) {
	localStorage.setItem('currentInput', localStorage.getItem('currentInput') + symbol);
	updateAfterInput();
}

function removeCapsule() {
	localStorage.setItem('currentInput', localStorage.getItem('currentInput').slice(0, -1));
	updateAfterInput();
}

function updateAfterInput() {
	var currentInput = localStorage.getItem('currentInput');

	// Update the "capsule history" list
	var table_html = "";
	for (var symbol of currentInput) {
		table_html += "<span class='capsule " + SYMBOL_TO_NAME[symbol] + "'>&nbsp;</span>";
	}
	document.getElementById("currentCapsules").innerHTML = table_html || "&nbsp;";

	// Update the Cycle table
	drawCycleTable();

	// Determine results and display them
	if (currentInput.length == 0) {
		document.getElementById("results").innerHTML = "Add capsules above to see possibilities for the next capsule.";
		return;
	}
	
	foundIndices = findIndicesOfInput();

	var soonestCapsules = [];
	var symbolCounts = {};
	for (var capsule of CAPSULES) {
		symbolCounts[capsule.symbol] = 0;
	}

	for (var foundIndex of foundIndices) {
		nextIndex = (foundIndex + currentInput.length) % CYCLE.length;
		lastIndex = (foundIndex + currentInput.length - 1) % CYCLE.length;
		
		document.getElementById(nextIndex).classList.add("possible-end");
		symbolCounts[CYCLE[nextIndex]]++;
		
		// Find the minimum number of capsules after lastIndex before you open each type of capsule
		var capsuleDistance = {};
		var capsulesFound = 0;
		var searchIndex = nextIndex;
		while (capsulesFound < CAPSULES.length &&
			(searchIndex % CYCLE.length != nextIndex || searchIndex == nextIndex)) {
			
			if (!(CYCLE[searchIndex % CYCLE.length] in capsuleDistance)) {
				capsuleDistance[CYCLE[searchIndex % CYCLE.length]] = (searchIndex - lastIndex + CYCLE.length) % CYCLE.length;
				capsulesFound++;
			}
			searchIndex++;
		}
		
		soonestCapsules.push(capsuleDistance);
	}
	
	var results_html = "Total possibilities: " + foundIndices.length + "<br />";
	if (foundIndices.length > 0) {
		// Calculate table cell values
		var tableElements = {};
		for (var capsule of CAPSULES) {
			var tableElement = {};
			var count = symbolCounts[capsule.symbol];
			var percent = Math.round(100 * count / foundIndices.length);
			var distances = soonestCapsules.map(distsPerSymbol => distsPerSymbol[capsule.symbol])
			var min = Math.min(...distances);
			var max = Math.max(...distances);
			tableElement['range_text'] = (min == max) ? min : min + "-" + max;
			tableElement.count_text = (count == 0) ? "&nbsp;" : count + " (" + percent + "%)";
			tableElement.image_html = "<span class='capsule " + capsule.name + "'>&nbsp;</span>";
			tableElements[capsule.symbol] = tableElement;
		}

		// Construct the table
		results_html += "<table id='resultsTable'><tr><th>&nbsp;</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].image_html + "</td>";
		}
		results_html += "</tr><tr><th>Next</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].count_text + "</td>";
		}
		results_html += "</tr><tr><th># Until</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].range_text + "</td>";
		}
		results_html += "</tr></table>";
	}
	document.getElementById("results").innerHTML = results_html;
}

function findIndicesOfInput() {
	var currentInput = localStorage.getItem('currentInput');

	var result = [];

	var index = TWO_CYCLES.indexOf(currentInput);
	while (index != -1 && index < CYCLE.length) {
		result.push(index);
		index = TWO_CYCLES.indexOf(currentInput, index + 1);
	}

	return result;
}

function drawCycleTable() {
	var table_html = "";
	var index = 0;

	for (var row = 0; row < 24; row++) {
		table_html += "<div>";
		for (var col = 0; col < 10; col++) {
			table_html += "<span id='" + index + "' class='capsule " + SYMBOL_TO_NAME[CYCLE[index]] + "'>&nbsp;</span>";
			index++;
		}
		table_html += "</div>";
	}

	document.getElementById("table").innerHTML = table_html;
}
</script>
</html>
