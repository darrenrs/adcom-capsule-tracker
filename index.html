<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" type="image/png" href="Wood.png">
<title>Adventure Communist Free Capsules</title>
<style type="text/css">
h3 {
	margin: 5px;
}

p {
	margin: 5px;
}

.section {
	border-style: solid;
	margin-bottom: 5px;
	width: 550px;
}

.label { /* taken from scripter17's adcomm-capsule-finder */
	color: white;
	text-shadow:1px 1px 0px black, 1px -1px 0px black, -1px 1px 0px black, -1px -1px 0px black;
	text-align:right;
	line-height:calc(300%);
}

.capsule {
	width: 40px;
	height: 35px;
	margin: 5px 5px;
	background-repeat: no-repeat;
	background-position: center;
	display: inline-block;
}
.Wood {
	background-image: url("Wood.png");
}
.Stone {
	background-image: url("Stone.png");
}
.Iron {
	background-image: url("Iron.png");
}
.Epic {
	background-image: url("Epic.png");
}
.Supreme {
	background-image: url("Supreme.png");
}
.Wild1 {
	background-image: url("Wild1.png");
}
.Wild5 {
	background-image: url("Wild5.png");
}
.remove {
	background-image: url("remove-small.png");
}

.possible-end {
	background-color: #a7f45a;
}

#currentCapsules {
	min-height: 45px;
}
#resultsTable {
	text-align:center;
}
#resultsTable td {
	padding: 5px;
}
</style>
</head>
<body>
<p>
<div class="section">
	<h3>Capsule History:</h3>
	<p><strong>Capsule List:</strong></p>
	<div id="currentCapsules">&nbsp;</div>
	<p><strong>Add Capsule:</strong></p>
	<div>
		<a href="#" onclick="addCapsule('W');"><span class="capsule Wood">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('S');"><span class="capsule Stone">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('I');"><span class="capsule Iron">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('E');"><span class="capsule Epic">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('U');"><span class="capsule Supreme">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('1');"><span class="capsule Wild1">&nbsp;</span></a>
		<a href="#" onclick="addCapsule('5');"><span class="capsule Wild5">&nbsp;</span></a>
		<a href="#" onclick="removeCapsule();"><span class="capsule remove">&nbsp;</span></a>
	</div>	
</div>
<div class="section">
	<h3>Next Capsule:</h3>
	<p id="results">&nbsp;</p>
</div>
<div class="section">
	<h3>Cycle</h3>
	<div id="table"></div>
</div>
</body>
<script type="text/javascript">
const CYCLE = "SWWWWIWWWWSWWWSWWWWSWWWWSWWWWSWWWWSWWWWSWWWWWSWWWWSWWWWSWWWWWWSWWWSWWWIWWWSWWWSWWWSWWWSWWWSWWWSWWWSWWSWWWWSWWWWSWWWSWWWUWWWSWWWIWWWWSWWWWWSWWWSWWWSWWWWSWWWWSWWWSWWWSWWWWSWWWWSWWSWWWSWWWSWWWWWIWWWSWWWWSWWWWSWWWWSWWWWWWSWWWWSWWWWSWWWWSWWWWEWW";

const CAPSULES = [
{ name: "Wood", symbol: "W" },
{ name: "Stone", symbol: "S" },
{ name: "Iron", symbol: "I" },
{ name: "Epic", symbol: "E" },
{ name: "Supreme", symbol: "U" }
];

var SYMBOL_TO_NAME = {
	1: 'Wild1',
	5: 'Wild5'
};
for (var capsule of CAPSULES) {
	SYMBOL_TO_NAME[capsule.symbol] = capsule.name;
}

if (localStorage.getItem('currentInput') == null) {
	localStorage.setItem('currentInput', '');
}
updateAfterInput();

function addCapsule(symbol) {
	localStorage.setItem('currentInput', localStorage.getItem('currentInput') + symbol);
	updateAfterInput();
}

function removeCapsule() {
	localStorage.setItem('currentInput', localStorage.getItem('currentInput').slice(0, -1));
	updateAfterInput();
}

function updateAfterInput() {
	var currentInput = localStorage.getItem('currentInput');
	
	var foundIndices = findIndicesOfInput();
	var nextIndices = new Set(foundIndices.map(x => x.nextIndex));

	// Update the "capsule history" list
	var table_html = "";
	var label_text = "&nbsp;";
	var path_index = 0;
	var cur_label_index = (nextIndices.size != 1) ? -1 : foundIndices[0].path[0];
	for (var symbol of currentInput) {
		if (nextIndices.size == 1) {
			if (symbol != '5') { // 5 means special 1-5 wildcard
				label_text = (cur_label_index + 1);
				cur_label_index = (cur_label_index + 1) % CYCLE.length;
			} else {
				label_text = "&nbsp;";
				path_index++;
				cur_label_index = foundIndices[0].path[path_index];
			}
		}
		table_html += "<span class='label capsule " + SYMBOL_TO_NAME[symbol] + "'>" + label_text + "</span>";
	}
	document.getElementById("currentCapsules").innerHTML = table_html || "&nbsp;";

	// Update the Cycle table
	drawCycleTable();

	// Determine results and display them
	if (currentInput.length == 0) {
		document.getElementById("results").innerHTML = "Add capsules above to see possibilities for the next capsule.";
		return;
	}	

	var soonestCapsules = [];
	var symbolCounts = {};
	for (var capsule of CAPSULES) {
		symbolCounts[capsule.symbol] = 0;
	}

	for (var nextIndex of nextIndices) {
		document.getElementById(nextIndex).classList.add("possible-end");
		symbolCounts[CYCLE[nextIndex]]++;
		
		// Find the minimum number of capsules after lastIndex before you open each type of capsule
		var capsuleDistance = {};
		var capsulesFound = 0;
		var searchIndex = nextIndex;
		while (capsulesFound < CAPSULES.length &&
			(searchIndex % CYCLE.length != nextIndex || searchIndex == nextIndex)) {
			
			if (!(CYCLE[searchIndex % CYCLE.length] in capsuleDistance)) {
				capsuleDistance[CYCLE[searchIndex % CYCLE.length]] =
					(searchIndex - nextIndex + CYCLE.length + 1) % CYCLE.length || CYCLE.length;
				capsulesFound++;
			}
			searchIndex++;
		}
		
		soonestCapsules.push(capsuleDistance);
	}
	
	var results_html = "";
	if (nextIndices.size == 0) {
		results_html = "Invalid history. You can use the 'minus' button to remove the most recent capsule.";
	} else {
		if (nextIndices.size > 1) {
			results_html = "Total possibilities: " + nextIndices.size + "<br />";
		}
		// Calculate table cell values
		var tableElements = {};
		for (var capsule of CAPSULES) {
			var tableElement = {};
			var count = symbolCounts[capsule.symbol];
			var percent = Math.round(100 * count / foundIndices.length);
			var distances = soonestCapsules.map(distsPerSymbol => distsPerSymbol[capsule.symbol])
			var min = Math.min(...distances);
			var max = Math.max(...distances);
			var label = "&nbsp;";
			var capsuleClass = capsule.name;
			if (nextIndices.size == 1) {
				if (count > 0) {
					capsuleClass += " possible-end";
				}
				label = ((foundIndices[0].nextIndex + min - 1) % CYCLE.length) + 1;
			}
			tableElement.range_text = (min == max) ? min : min + "-" + max;
			tableElement.count_text = (count == 0) ? "&nbsp;" : count + " (" + percent + "%)";
			tableElement.image_html = "<span class='label capsule " + capsuleClass + "'>" + label + "</span>";
			tableElements[capsule.symbol] = tableElement;
		}

		// Construct the table
		results_html += "<table id='resultsTable'><tr><th>&nbsp;</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].image_html + "</td>";
		}
		
		if (nextIndices.size > 1) {
			results_html += "</tr><tr><th>Next</th>";
			for (var capsule of CAPSULES) {
				results_html += "<td>" + tableElements[capsule.symbol].count_text + "</td>";
			}
		}
		
		results_html += "</tr><tr><th># Until</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].range_text + "</td>";
		}
		results_html += "</tr></table>";
	}
	document.getElementById("results").innerHTML = results_html;
}

function findIndicesOfInput() {
	return findIndicesOf(localStorage.getItem('currentInput'), 0, 0, CYCLE.length - 1);
}

function findIndicesOf(currentInput, currentInputStart, currentCycleStart, currentCycleEnd) {	
	var result = []
	for (var startIndex = currentCycleStart; startIndex <= currentCycleEnd; startIndex++) {
		var validStartIndex = true;
		for (var inputIndex = currentInputStart; inputIndex < currentInput.length; inputIndex++) {
			if (currentInput[inputIndex] == '5') {
				// 1-5 wildcard, try each possibility
				for (var wildDelta = 1; wildDelta < 6; wildDelta++) {
					var nextIndex = (startIndex + inputIndex + wildDelta - currentInputStart) % CYCLE.length;
					var nextResults = findIndicesOf(currentInput, inputIndex + 1, nextIndex, nextIndex);
					result = result.concat(nextResults.map(x => ({...x, startIndex: startIndex, path: [startIndex, ...x.path]})));
				}
				validStartIndex = false;
				break;
			} else if (currentInput[inputIndex] != '1' && currentInput[inputIndex] != CYCLE[(startIndex + inputIndex - currentInputStart) % CYCLE.length]) {
				validStartIndex = false;
				break;
			}
		}
		
		if (validStartIndex) {
			result.push({
				startIndex: startIndex,
				lastIndex: (startIndex + currentInput.length - currentInputStart - 1) % CYCLE.length,
				nextIndex: (startIndex + currentInput.length - currentInputStart) % CYCLE.length,
				path: [startIndex]
			});
		}
	}

	return result;
}

function drawCycleTable() {
	var table_html = "";
	var index = 0;

	for (var row = 0; row < 24; row++) {
		table_html += "<div>";
		for (var col = 0; col < 10; col++) {
			table_html += "<span id='" + index + "' class='label capsule " + SYMBOL_TO_NAME[CYCLE[index]] + "'>" + (index + 1) + "</span>";
			index++;
		}
		table_html += "</div>";
	}

	document.getElementById("table").innerHTML = table_html;
}
</script>
</html>
