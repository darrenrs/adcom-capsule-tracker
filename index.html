<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" type="image/png" href="Wood.png">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adventure Communist Free Capsules</title>
<style type="text/css">
h3 {
	margin: 5px;
}

p {
	margin: 5px;
}

.label { /* taken from scripter17's adcomm-capsule-finder */
	color: white;
	text-shadow:1px 1px 0px black, 1px -1px 0px black, -1px 1px 0px black, -1px -1px 0px black;
	text-align:right;
	line-height:calc(300%);
}

.startOverride {
	background-color: #007bff; /* bootstrap primary */
	color: lightblue;
}
.path {
	background-color: #17a2b8; /* bootstrap info */
}

.capsule {
	width: 40px;
	height: 35px;
	margin: 5px 5px;
	background-repeat: no-repeat;
	background-position: center;
	display: inline-block;
}
.capsule-no-margin {
	width: 40px;
	height: 35px;
	background-repeat: no-repeat;
	background-position: center;
	display: inline-block;
}

.Wood {
	background-image: url("Wood.png");
}
.Stone {
	background-image: url("Stone.png");
}
.Iron {
	background-image: url("Iron.png");
}
.Epic {
	background-image: url("Epic.png");
}
.Supreme {
	background-image: url("Supreme.png");
}
.Wild1 {
	background-image: url("Wild1.png");
}
.Wild5 {
	background-image: url("Wild5.png");
}
.remove {
	background-image: url("remove-small.png");
}
.export {
	background-image: url("Export.png");
}

.possible-end {
	background-color: #28a745; /* bootstrap success */
}

#currentCapsules {
	min-height: 90px;
}
#resultsTable {
	text-align:center;
}
#resultsTable td {
	padding: 5px;
}
#dividingBar {
	border-left: 4px solid;
	display: inline-block;	
	width: 0px;
	margin: 0px 10px 0px 10px;
	
}

@media screen and (max-width: 799px) {
	/* History and Cycle cols: 10, next vertical */
	#historyCard { width:550px; }
	#nextCard { width:400px; display: block; position: static; }
	#cycleCard { width: 550px; }	
}
@media screen and (min-width:800px) and (max-width: 1049px) {
	/* History and Cycle cols: 15, next vertical */ 
	#historyCard { width: 800px; }
	#nextCard { width:400px; display: block; position: static; }
	#cycleCard { width: 800px; }	
}
@media screen and (min-width:1050px) and (max-width: 1239px) {
	/* History cols: 10, Cycle cols: 20, next horiz */
	#historyCard { width: 550px; }
	#nextCard { width:400px; display: inline-block; position: absolute; top:0px; }
	#cycleCard { width: 1050px; }
}
@media screen and (min-width:1240px) {
	/* History cols: 15, Cycle cols: 20, next horiz */
	#historyCard { width: 800px; }
	#nextCard { width:400px; display: inline-block; position: absolute; top:0px; }
	#cycleCard { width: 1050px; }
}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<a class="navbar-brand" href="#">Free Capsule Tracker</a>
	<ul class="navbar-nav">
		<li class="nav-item active" id="mainButton"><a class="nav-link" href="#" onclick="switchMode('main')">Main</a></li>
		<li class="nav-item" id="eventButton"><a class="nav-link" href="#" onclick="switchMode('event')">Event</a></li>
	</ul>
</nav>
<div style="position:relative">
<span class="card mx-2 mt-1" style="display:inline-block;" id="historyCard">
	<h4 class="card-header">Capsule History:</h4>
	<div class="card-body">
	<div id="currentCapsules">&nbsp;</div>
	<p class="card-text"><strong>Add Capsule:</strong></p>
	<div class="btn-toolbar" role="toolbar">
		<div class="btn-group mb-1" role="group">
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('W');"><span class="capsule-no-margin Wood">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('S');"><span class="capsule-no-margin Stone">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('I');"><span class="capsule-no-margin Iron">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('E');"><span class="capsule-no-margin Epic">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('U');"><span class="capsule-no-margin Supreme">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('1');"><span class="capsule-no-margin Wild1">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="addCapsule('5');"><span class="capsule-no-margin Wild5">&nbsp;</span></button>
		</div>
		<span id="dividingBar">&nbsp;</span>
		<div class="btn-group mb-1" role="group">
			<button type="button" class="btn btn-outline-secondary" onclick="toggleBlock('exportBlock');"><span class="capsule export">&nbsp;</span></button>
			<button type="button" class="btn btn-outline-secondary" onclick="removeCapsule();"><span class="capsule remove">&nbsp;</span></button>
		</div>
	</div>
	<p id='exportBlock' style='display:none;'><strong>Export URL:</strong> <input id='exportUrl' type='text' size='40' readonly></input><p>
	</div> <!--cardbody-->
</span>
<span class="card mx-2 mt-1" id="nextCard">
	<h4 class="card-header">Next Capsule:</h4>
	<div class="card-body" id="results">&nbsp;</div>
</span>
</div>
<div class="card mx-2 mt-1" id="cycleCard">
	<h4 class="card-header">Cycle</h4>
	<div class="card-body" id="table"></div>
</div>
<footer>
<p>Made by Zephyron1237. Source on <a href='https://github.com/zephyron1237/adcom-capsule-tracker'>GitHub</a>. Version 3 (<a href='#' onclick="toggleBlock('changelist')">Changelist</a>)</p>
<div id="changelist" style="display:none">
<ul>
<li><strong>Version 3</strong>
	<ul>
	<li>Added wildcards for 1 capsule and 1-5 capsules.</li>
	<li>Added optional starting capsule override.</li>
	<li>Added export/import.</li>
	<li>UI Improvements</li>
	</ul>
</li>
<li><strong>Version 2</strong>
	<ul>
	<li>Added automatic saving of progress.</li>
	<li>Added ranges for expected distances to each capsule type.</li>
	</ul>
</li>
</ul>
</div>
</footer>
</body>
<script type="text/javascript">
const CYCLE = "SWWWWIWWWWSWWWSWWWWSWWWWSWWWWSWWWWSWWWWSWWWWWSWWWWSWWWWSWWWWWWSWWWSWWWIWWWSWWWSWWWSWWWSWWWSWWWSWWWSWWSWWWWSWWWWSWWWSWWWUWWWSWWWIWWWWSWWWWWSWWWSWWWSWWWWSWWWWSWWWSWWWSWWWWSWWWWSWWSWWWSWWWSWWWWWIWWWSWWWWSWWWWSWWWWSWWWWWWSWWWWSWWWWSWWWWSWWWWEWW";

const CAPSULES = [
{ name: "Wood", symbol: "W" },
{ name: "Stone", symbol: "S" },
{ name: "Iron", symbol: "I" },
{ name: "Epic", symbol: "E" },
{ name: "Supreme", symbol: "U" }
];

var SYMBOL_TO_NAME = {
	1: 'Wild1',
	5: 'Wild5'
};
for (var capsule of CAPSULES) {
	SYMBOL_TO_NAME[capsule.symbol] = capsule.name;
}

var splitUrl = window.location.href.split('?');
if (splitUrl.length == 2) {
	localStorage.setItem('currentInput', '');
	localStorage.setItem('startOverride', -1);
	
	var arguments = splitUrl[1].split('&');
	for (var arg of arguments) {
		var keyValue = arg.split('=');
		if (keyValue.length != 2) continue;
		if (keyValue[0] == 'start') {
			localStorage.setItem('startOverride', parseInt(keyValue[1]) - 1);
		} else if (keyValue[0] == 'input') {
			localStorage.setItem('currentInput', keyValue[1]);
		}
	}
	window.location.href = splitUrl[0];
}

if (localStorage.getItem('currentInput') == null) {
	localStorage.setItem('currentInput', '');
}
if (localStorage.getItem('startOverride') == null) {
	localStorage.setItem('startOverride', -1);
}
updateAfterInput();

function addCapsule(symbol) {
	localStorage.setItem('currentInput', localStorage.getItem('currentInput') + symbol);
	updateAfterInput();
}

function removeCapsule() {
	var currentInput = localStorage.getItem('currentInput');
	if (currentInput == '') {
		localStorage.setItem('startOverride', -1);
	} else {
		localStorage.setItem('currentInput', currentInput.slice(0, -1));
	}
	updateAfterInput();
}

function updateAfterInput() {
	var currentInput = localStorage.getItem('currentInput');
	var startOverride = parseInt(localStorage.getItem('startOverride'));
	
	var foundIndices = findIndicesOfInput();
	var nextIndices = new Set(foundIndices.map(x => x.nextIndex));

	// Update the "capsule history" list
	var table_html = "";
	var label_text = "&nbsp;";
	var path_index = 0;
	var cur_label_index = (nextIndices.size != 1) ? -1 : foundIndices[0].path[0];
	
	if (startOverride != -1) {		
		var symbol_class = SYMBOL_TO_NAME[CYCLE[startOverride]];
		var override_label = startOverride + 1;
		table_html += "<a href='#' onclick='setStartOverride(-1)'><span class='startOverride label capsule " + symbol_class + "'>" + override_label + "</span></a>";
	}
	
	for (var symbol of currentInput) {
		var inputClass = SYMBOL_TO_NAME[symbol];
		if (nextIndices.size == 1) {
			inputClass += " path";
			if (symbol != '5') { // 5 means special 1-5 wildcard
				label_text = (cur_label_index + 1);
				cur_label_index = (cur_label_index + 1) % CYCLE.length;				
			} else {
				label_text = "&nbsp;";
				path_index++;
				cur_label_index = foundIndices[0].path[path_index];
			}			
		}
		table_html += "<span class='label capsule " + inputClass + "'>" + label_text + "</span>";
	}
	document.getElementById("currentCapsules").innerHTML = table_html || "&nbsp;";
	
	var exportUrl = "https://zephyron1237.github.io/adcom-capsule-tracker/?";
	if (nextIndices.size == 1) {
		 exportUrl += "start=" + (foundIndices[0].lastIndex + 1);
	} else {
		if (startOverride != -1) {
			exportUrl += "start=" + (startOverride + 1) + "&";
		}
		exportUrl += "input=" + currentInput;
	}
	document.getElementById("exportUrl").value = exportUrl;

	// Update the Cycle table
	drawCycleTable();
	
	// Highlight Cycle table
	if (startOverride != -1) {
		document.getElementById(startOverride).classList.add('startOverride');
	}
	if (nextIndices.size == 1) {
		for (var index = foundIndices[0].startIndex; index != foundIndices[0].nextIndex; index = (index + 1) % CYCLE.length) {
			if (index == startOverride) continue;
			document.getElementById(index).classList.add('path');
		}		
	}

	// Determine results and display them
	if (currentInput.length == 0 && startOverride == -1) {
		document.getElementById("results").innerHTML = "<ul><li>Add capsules above to see possibilities for the next capsule.</li><li>You can also choose a capsule below to start your history.</li></ul>";
		return;
	}	

	var soonestCapsules = [];
	var symbolCounts = {};
	for (var capsule of CAPSULES) {
		symbolCounts[capsule.symbol] = 0;
	}

	for (var nextIndex of nextIndices) {
		document.getElementById(nextIndex).classList.add("possible-end");
		symbolCounts[CYCLE[nextIndex]]++;
		
		// Find the minimum number of capsules after lastIndex before you open each type of capsule
		var capsuleDistance = {};
		var capsulesFound = 0;
		var searchIndex = nextIndex;
		while (capsulesFound < CAPSULES.length &&
			(searchIndex % CYCLE.length != nextIndex || searchIndex == nextIndex)) {
			
			if (!(CYCLE[searchIndex % CYCLE.length] in capsuleDistance)) {
				capsuleDistance[CYCLE[searchIndex % CYCLE.length]] =
					(searchIndex - nextIndex + CYCLE.length + 1) % CYCLE.length || CYCLE.length;
				capsulesFound++;
			}
			searchIndex++;
		}
		
		soonestCapsules.push(capsuleDistance);
	}
	
	var results_html = "";
	if (nextIndices.size == 0) {
		results_html = "Invalid history. You can use the 'minus' button to remove the most recent capsule.";
	} else {
		if (nextIndices.size > 1) {
			results_html = "Total possibilities: " + nextIndices.size + "<br />";
		}
		// Calculate table cell values
		var tableElements = {};
		for (var capsule of CAPSULES) {
			var tableElement = {};
			var count = symbolCounts[capsule.symbol];
			var percent = Math.round(100 * count / foundIndices.length);
			var distances = soonestCapsules.map(distsPerSymbol => distsPerSymbol[capsule.symbol])
			var min = Math.min(...distances);
			var max = Math.max(...distances);
			var label = "&nbsp;";
			var capsuleClass = capsule.name;
			if (nextIndices.size == 1) {
				if (count > 0) {
					capsuleClass += " possible-end";
				}
				label = ((foundIndices[0].nextIndex + min - 1) % CYCLE.length) + 1;
			}
			tableElement.range_text = (min == max) ? min : min + "-" + max;
			tableElement.count_text = (count == 0) ? "&nbsp;" : count + " (" + percent + "%)";
			tableElement.image_html = "<span class='label capsule " + capsuleClass + "'>" + label + "</span>";
			tableElements[capsule.symbol] = tableElement;
		}

		// Construct the table
		results_html += "<table id='resultsTable'><tr><th>&nbsp;</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].image_html + "</td>";
		}
		
		if (nextIndices.size > 1) {
			results_html += "</tr><tr><th>Next</th>";
			for (var capsule of CAPSULES) {
				results_html += "<td>" + tableElements[capsule.symbol].count_text + "</td>";
			}
		}
		
		results_html += "</tr><tr><th>Until</th>";
		for (var capsule of CAPSULES) {
			results_html += "<td>" + tableElements[capsule.symbol].range_text + "</td>";
		}
		results_html += "</tr></table>";
	}
	document.getElementById("results").innerHTML = results_html;
}

function findIndicesOfInput() {
	var startOverride = parseInt(localStorage.getItem('startOverride'));
	if (startOverride == -1) {
		return findIndicesOf(localStorage.getItem('currentInput'), 0, 0, CYCLE.length - 1);
	} else {
		var nextIndex = (startOverride + 1) % CYCLE.length;
		return findIndicesOf(localStorage.getItem('currentInput'), 0, nextIndex, nextIndex);
	}
}

function findIndicesOf(currentInput, currentInputStart, currentCycleStart, currentCycleEnd) {	
	var result = []
	for (var startIndex = currentCycleStart; startIndex <= currentCycleEnd; startIndex++) {
		var validStartIndex = true;
		for (var inputIndex = currentInputStart; inputIndex < currentInput.length; inputIndex++) {
			if (currentInput[inputIndex] == '5') {
				// 1-5 wildcard, try each possibility
				for (var wildDelta = 1; wildDelta < 6; wildDelta++) {
					var nextIndex = (startIndex + inputIndex + wildDelta - currentInputStart) % CYCLE.length;
					var nextResults = findIndicesOf(currentInput, inputIndex + 1, nextIndex, nextIndex);
					result = result.concat(nextResults.map(x => ({...x, startIndex: startIndex, path: [startIndex, ...x.path]})));
				}
				validStartIndex = false;
				break;
			} else if (currentInput[inputIndex] != '1' && currentInput[inputIndex] != CYCLE[(startIndex + inputIndex - currentInputStart) % CYCLE.length]) {
				validStartIndex = false;
				break;
			}
		}
		
		if (validStartIndex) {
			result.push({
				startIndex: startIndex,
				lastIndex: (startIndex + currentInput.length - currentInputStart - 1) % CYCLE.length,
				nextIndex: (startIndex + currentInput.length - currentInputStart) % CYCLE.length,
				path: [startIndex]
			});
		}
	}

	return result;
}

function drawCycleTable() {
	var table_html = "";

	for (var index in CYCLE) {
		table_html += "<a href='#' onclick='setStartOverride(" + index + ")'><span id='" + index + "' class='label capsule " + SYMBOL_TO_NAME[CYCLE[index]] + "'>" + (parseInt(index) + 1) + "</span></a>";
	}

	document.getElementById("table").innerHTML = table_html;
}

function setStartOverride(startOverride) {
	// TODO: Notify user that this is an (in)valid selection. Maybe a BG color animation?
	var currentInput = localStorage.getItem('currentInput');
	if (startOverride == -1 || currentInput == "") {
		localStorage.setItem('startOverride', startOverride);
		updateAfterInput();
	} else {
		var indexAfterStart = (startOverride + 1) % CYCLE.length;
		var foundIndices = findIndicesOf(currentInput, 0, indexAfterStart, indexAfterStart);
		if (foundIndices.length > 0) {
			localStorage.setItem('startOverride', startOverride);
			updateAfterInput();
		}		
	}
}

function toggleBlock(blockId) {
	var exportBlock = document.getElementById(blockId);
	if (exportBlock.style.display != 'block') {
		exportBlock.style.display = 'block'
	} else {
		exportBlock.style.display = 'none'
	}
}
</script>
</html>
